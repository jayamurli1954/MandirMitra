# Backend Logging Guide

## üìã Overview

The backend generates **two types of logs**:

1. **Console Logs** - Printed to terminal/console (for debugging)
2. **Audit Logs** - Stored in database (for security and compliance)

---

## 1. Console Logs (Terminal Output)

### What You See in Terminal

When you run `uvicorn app.main:app --reload`, you'll see:

#### A. Server Startup Logs
```
INFO:     Will watch for changes in these directories: ['D:\\MandirSync\\backend']
INFO:     Uvicorn running on http://127.0.0.1:8000 (Press CTRL+C to quit)
INFO:     Started reloader process [2400] using WatchFiles
INFO:     Started server process [27344]
INFO:     Waiting for application startup.
‚úÖ Default admin user created: admin@temple.com / admin123
   OR
‚ÑπÔ∏è  Admin user already exists
INFO:     Application startup complete.
```

**Location:** `backend/app/core/database.py` - `init_db()` function

---

#### B. HTTP Request Logs
```
INFO:     127.0.0.1:52263 - "GET /api/v1/donations HTTP/1.1" 200 OK
INFO:     127.0.0.1:51919 - "POST /api/v1/donations HTTP/1.1" 201 Created
INFO:     127.0.0.1:55355 - "GET /api/v1/panchang/today HTTP/1.1" 200 OK
```

**What it shows:**
- IP address and port of client
- HTTP method and endpoint
- Response status code

**Generated by:** Uvicorn (FastAPI's ASGI server)

---

#### C. Error Logs
```
ERROR:    Exception in ASGI application
Traceback (most recent call last):
  File "...", line X, in function_name
    ...
AttributeError: ...
```

**Generated by:** FastAPI/Uvicorn when exceptions occur

---

#### D. Application Print Statements

**1. Database Initialization:**
```python
# backend/app/core/database.py
print("‚úÖ Default admin user created: admin@temple.com / admin123")
print("‚ÑπÔ∏è  Admin user already exists")
print("‚ùå Error creating admin user: {error}")
```

**2. Encryption Warnings:**
```python
# backend/app/core/data_encryption.py
print("‚ö†Ô∏è  WARNING: ENCRYPTION_KEY not set. Generated temporary key.")
print("‚ö†Ô∏è  Set ENCRYPTION_KEY in .env file for production!")
```

**3. Accounting Errors:**
```python
# backend/app/api/donations.py
print(f"ERROR: Credit account not found for donation category '{category.name}'")
print(f"ERROR: Credit account not found for seva '{seva.name}'")
```

**4. Panchang Calculation Errors:**
```python
# backend/app/services/panchang_service.py
print("Error calculating sunrise/sunset: {error}")
print("Error calculating moon rise/set: {error}")
```

---

## 2. Audit Logs (Database)

### What Are Audit Logs?

**Audit logs** are **permanent records** stored in the `audit_logs` database table. They track:
- **Who** did what (user name, email, role)
- **What** action was performed
- **When** it happened (timestamp)
- **Where** from (IP address, user agent)
- **What changed** (old values, new values, changes)

---

### Where Audit Logs Are Created

#### A. Authentication Events

**File:** `backend/app/api/auth.py`

**1. Successful Login:**
```python
log_action(
    db=db,
    user=user,
    action="LOGIN_SUCCESS",
    entity_type="User",
    entity_id=user.id,
    description=f"Successful login for {user.email}",
    ip_address=request.client.host,
    user_agent=request.headers.get("user-agent")
)
```

**2. Failed Login:**
```python
log_action(
    db=db,
    user=user,
    action="LOGIN_FAILED",
    entity_type="User",
    entity_id=user.id,
    description=f"Failed login attempt for {user.email}",
    ip_address=request.client.host,
    user_agent=request.headers.get("user-agent")
)
```

---

#### B. Donation Events

**File:** `backend/app/api/donations.py`

**1. Donation Created:**
```python
log_action(
    db=db,
    user=current_user,
    action="CREATE_DONATION",
    entity_type="Donation",
    entity_id=db_donation.id,
    new_values=donation.dict(),
    description=f"Donation {db_donation.receipt_number} created by {current_user.full_name}",
    ip_address=request.client.host if request else None,
    user_agent=request.headers.get("user-agent") if request else None
)
```

**2. Donation Updated:**
```python
log_action(
    db=db,
    user=current_user,
    action="UPDATE_DONATION",
    entity_type="Donation",
    entity_id=donation_id,
    old_values=old_values,
    new_values=update_data,
    description=f"Donation {donation.receipt_number} updated"
)
```

---

#### C. Seva Booking Events

**File:** `backend/app/api/sevas.py`

**1. Seva Booking Created:**
```python
log_action(
    db=db,
    user=current_user,
    action="CREATE_SEVA_BOOKING",
    entity_type="SevaBooking",
    entity_id=booking.id,
    new_values=booking_data,
    description=f"Seva booking {booking.receipt_number} created"
)
```

**2. Seva Reschedule:**
```python
log_action(
    db=db,
    user=current_user,
    action="RESCHEDULE_SEVA",
    entity_type="SevaBooking",
    entity_id=booking_id,
    description=f"Seva reschedule requested/approved"
)
```

---

#### D. User Management Events

**File:** `backend/app/api/users.py`

**1. User Created:**
```python
log_action(
    db=db,
    user=current_user,
    action="CREATE_USER",
    entity_type="User",
    entity_id=new_user.id,
    new_values=user_data.dict(),
    description=f"User {new_user.email} created by {current_user.full_name}"
)
```

**2. User Updated:**
```python
log_action(
    db=db,
    user=current_user,
    action="UPDATE_USER",
    entity_type="User",
    entity_id=user_id,
    old_values=old_values,
    new_values=update_data,
    description=f"User {user.email} updated"
)
```

**3. User Deactivated:**
```python
log_action(
    db=db,
    user=current_user,
    action="DEACTIVATE_USER",
    entity_type="User",
    entity_id=user_id,
    description=f"User {user.email} deactivated"
)
```

---

#### E. Certificate Events

**File:** `backend/app/api/certificates.py`

**1. Certificate Uploaded:**
```python
log_action(
    db=db,
    user=current_user,
    action="UPLOAD_CERTIFICATE",
    entity_type="Certificate",
    description=f"Uploaded certificate: {file.filename}",
    ip_address=request.client.host,
    user_agent=request.headers.get("user-agent")
)
```

**2. Certificate Downloaded:**
```python
log_action(
    db=db,
    user=current_user,
    action="DOWNLOAD_CERTIFICATE",
    entity_type="Certificate",
    entity_id=certificate_id,
    description=f"Downloaded certificate {certificate_id}"
)
```

**3. Certificate Deleted:**
```python
log_action(
    db=db,
    user=current_user,
    action="DELETE_CERTIFICATE",
    entity_type="Certificate",
    entity_id=certificate_id,
    description=f"Deleted certificate {certificate_id}"
)
```

---

## 3. Audit Log Database Structure

**Table:** `audit_logs`

**Fields:**
- `id` - Unique log entry ID
- `user_id` - User who performed action
- `user_name` - User's full name (denormalized)
- `user_email` - User's email (denormalized)
- `user_role` - User's role (denormalized)
- `action` - Action type (e.g., "CREATE_DONATION", "LOGIN_SUCCESS")
- `entity_type` - Type of entity (e.g., "Donation", "User", "SevaBooking")
- `entity_id` - ID of affected entity
- `old_values` - Previous state (JSON)
- `new_values` - New state (JSON)
- `changes` - Diff of changes (JSON)
- `ip_address` - User's IP address
- `user_agent` - Browser/client info
- `description` - Human-readable description
- `created_at` - Timestamp

---

## 4. Viewing Audit Logs

### Via API (Admin Only)

**Endpoint:** `GET /api/v1/audit-logs/`

**Query Parameters:**
- `user_id` - Filter by user
- `action` - Filter by action type
- `entity_type` - Filter by entity type
- `start_date` - Start date filter
- `end_date` - End date filter
- `limit` - Number of results
- `offset` - Pagination offset

**Example:**
```bash
GET /api/v1/audit-logs/?action=CREATE_DONATION&limit=50
```

---

### Via Database Query

```sql
-- View all audit logs
SELECT * FROM audit_logs ORDER BY created_at DESC LIMIT 100;

-- View login attempts
SELECT * FROM audit_logs WHERE action IN ('LOGIN_SUCCESS', 'LOGIN_FAILED') ORDER BY created_at DESC;

-- View donation-related actions
SELECT * FROM audit_logs WHERE entity_type = 'Donation' ORDER BY created_at DESC;

-- View actions by specific user
SELECT * FROM audit_logs WHERE user_email = 'clerk1@temple.local' ORDER BY created_at DESC;
```

---

## 5. Log Types Summary

### Security-Related Logs

| Action | Description | When Logged |
|--------|-------------|-------------|
| `LOGIN_SUCCESS` | Successful login | Every login |
| `LOGIN_FAILED` | Failed login attempt | Every failed login |
| `CREATE_USER` | New user created | User creation |
| `UPDATE_USER` | User updated | User profile update |
| `DEACTIVATE_USER` | User deactivated | User deactivation |
| `UPLOAD_CERTIFICATE` | Certificate uploaded | File upload |
| `DOWNLOAD_CERTIFICATE` | Certificate downloaded | File download |
| `DELETE_CERTIFICATE` | Certificate deleted | File deletion |

### Business Logic Logs

| Action | Description | When Logged |
|--------|-------------|-------------|
| `CREATE_DONATION` | Donation created | Every donation |
| `UPDATE_DONATION` | Donation updated | Donation edit |
| `DELETE_DONATION` | Donation deleted | Donation deletion |
| `CREATE_SEVA_BOOKING` | Seva booked | Every booking |
| `UPDATE_SEVA_BOOKING` | Seva booking updated | Booking edit |
| `RESCHEDULE_SEVA` | Seva rescheduled | Reschedule request/approval |
| `CREATE_ACCOUNT` | Account created | Chart of accounts |
| `POST_JOURNAL_ENTRY` | Journal entry posted | Accounting entry |

---

## 6. Logging Best Practices

### ‚úÖ What Gets Logged

1. **All user actions** - Create, update, delete operations
2. **Authentication events** - Login success/failure
3. **Security events** - Certificate access, user management
4. **Financial transactions** - Donations, seva bookings, journal entries
5. **Sensitive operations** - User role changes, account modifications

### ‚ùå What Doesn't Get Logged

1. **Read-only operations** - Viewing data (unless sensitive)
2. **System operations** - Background tasks, scheduled jobs
3. **Password changes** - For security (no password values logged)
4. **Search queries** - General searches (unless sensitive data)

---

## 7. Log Retention

### Current Implementation

- **Audit logs are permanent** - Not automatically deleted
- **No retention policy** - All logs kept indefinitely
- **Database storage** - Stored in PostgreSQL

### Recommended for Production

1. **Archive old logs** - Move logs older than 1 year to archive table
2. **Retention policy** - Keep audit logs for 7 years (compliance)
3. **Backup strategy** - Regular backups of audit_logs table
4. **Monitoring** - Alert on suspicious patterns

---

## 8. Security Considerations

### Sensitive Data in Logs

**What's NOT logged:**
- ‚ùå Passwords (never logged)
- ‚ùå Password hashes (excluded from audit logs)
- ‚ùå JWT tokens (never logged)
- ‚ùå Encryption keys (never logged)

**What IS logged:**
- ‚úÖ User actions (who, what, when)
- ‚úÖ IP addresses (for security tracking)
- ‚úÖ User agent (browser/client info)
- ‚úÖ Entity changes (old/new values)
- ‚úÖ Descriptions (human-readable)

---

## 9. Troubleshooting

### No Audit Logs Being Created?

1. **Check database table exists:**
   ```sql
   SELECT * FROM audit_logs LIMIT 1;
   ```

2. **Check if user is authenticated:**
   - Audit logs require authenticated user
   - Check `current_user` is not None

3. **Check database connection:**
   - Ensure database is accessible
   - Check for connection errors in console

### Too Many Console Logs?

1. **Disable SQL logging:**
   ```python
   # In .env file
   SQL_ECHO=False
   ```

2. **Remove print statements:**
   - Replace `print()` with proper logging
   - Use Python's `logging` module

### Audit Logs Growing Too Large?

1. **Archive old logs:**
   ```sql
   -- Move logs older than 1 year to archive
   CREATE TABLE audit_logs_archive AS 
   SELECT * FROM audit_logs 
   WHERE created_at < NOW() - INTERVAL '1 year';
   
   DELETE FROM audit_logs 
   WHERE created_at < NOW() - INTERVAL '1 year';
   ```

2. **Add indexes:**
   ```sql
   CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
   CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
   CREATE INDEX idx_audit_logs_action ON audit_logs(action);
   ```

---

## 10. Example Log Entries

### Successful Login
```json
{
  "id": 1,
  "user_id": 2,
  "user_name": "Clerk 1",
  "user_email": "clerk1@temple.local",
  "user_role": "clerk",
  "action": "LOGIN_SUCCESS",
  "entity_type": "User",
  "entity_id": 2,
  "ip_address": "127.0.0.1",
  "user_agent": "Mozilla/5.0...",
  "description": "Successful login for clerk1@temple.local",
  "created_at": "2025-11-24T10:30:00"
}
```

### Donation Created
```json
{
  "id": 15,
  "user_id": 2,
  "user_name": "Clerk 1",
  "user_email": "clerk1@temple.local",
  "user_role": "clerk",
  "action": "CREATE_DONATION",
  "entity_type": "Donation",
  "entity_id": 10,
  "new_values": {
    "amount": 1000.0,
    "category": "General Donation",
    "payment_method": "cash",
    "receipt_number": "TMP1-2025-00010"
  },
  "description": "Donation TMP1-2025-00010 created by Clerk 1",
  "ip_address": "127.0.0.1",
  "user_agent": "Mozilla/5.0...",
  "created_at": "2025-11-24T10:35:00"
}
```

---

## üìä Summary

### Console Logs (Terminal)
- ‚úÖ Server startup messages
- ‚úÖ HTTP request logs (Uvicorn)
- ‚úÖ Error traces
- ‚úÖ Application print statements
- ‚ö†Ô∏è **Not persistent** - Lost when server restarts

### Audit Logs (Database)
- ‚úÖ All user actions
- ‚úÖ Authentication events
- ‚úÖ Security events
- ‚úÖ Financial transactions
- ‚úÖ **Permanent** - Stored in database
- ‚úÖ **Queryable** - Can search and filter
- ‚úÖ **Compliance** - Meets audit requirements

---

**Last Updated:** November 2025  
**For questions:** Check `backend/app/core/audit.py` and `backend/app/models/audit_log.py`









